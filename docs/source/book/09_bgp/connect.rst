Подключение к провайдерам
#########################

Для начала рассмотрим что надо знать перед тем как установить BGP пиринг.

  1. Получить номер автономной системы и IP адреса. Для это нет необходимости станосится LIR.
  2. Закрепить данные из номера 1 в базе RIPE.

C IP более менее все понятно. Остается вопрос что такое ASN

ASN
~~~

Автономная система - Система IP-сетей и маршрутизаторов, управляемых одним или несколькими операторами, имеющими единую политику маршрутизации.

Диапазоны номеров автономных систем:

  * 0-65535 (изначально определенный диапазон для ASN 16 бит)
  * 65536-4294967295 (новый диапазон для ASN 32 бита (RFC 4893))(май 2007)

Использование ASN:

  * 0 и 65535  - зарезервированы
  * 1-64495 публичные номера (все что не выдали до 2012 – резерв у IANA)
  * 65552-4294967295 публичные номера (выдаются с 2010)
  * 64512-65534 - приватные номера
  * 23456 - представляет 32-битный диапазон на устройствах, которые работают с 16-битным диапазоном(для совместимости со старым оборудованием)

После перехода на 32-битные номера автономных систем немного поменялась терминология ASN. Теперь номера с 0 до 65535 называются “mappable ASN” (первые 16 бит в таких ASN – нули)

ASN32 могут записывать двумя видами:
  1. число от 0 до 4294967295
  2. как точка, разделяющая ASN32 на два 16 битовых значения: 78960(16)=1.13424(32)

Примеры записи ASN32 через точку:

::

   65535(16) = 0.65535(32)
   65531(16) = 1.0(32)
   65532(16) = 1.1(32)
   78960(16) = 1.13424(32)


Интересный номер 23456. Исползуется, когда соседство устанавливается с маршрутизатором, не понимающим ASN32. Тогда ""умный"" сосед вместо своей автономной системы указывает номер 23456. При этом
в дополнительных полях сообщений BGP будет указан верный номер автономной системы.

Таблицы BGP
~~~~~~~~~~~

Теперь когда мы готовы подключаться к провайдерам как именно мы хотим получать маршрутную информацию. На данный момент общее количество маршрутов в сети Интрнет уже больше 800к. и не любое оборудование готово принять такую
информацию и обработать ее в нужное нам время. И это тоже еще не все.

На маршрутизаторе есть общая таблица маршрутизации: RIB(routing information base). В ней содержаться вся обработанная маршрутная информация собраная из всех протоколов, с которыми работает маршрутизатор

Однако для BGP есть еще таблица FIB(forwarding information base). В этой таблице хранится информация полученная от конкретного протокола маршрутизации. И для каждого протокола такая таблица будет своя.
В ней хранится не обработанная информации. Можно сказать черновик всех маршрутов, которые приходят на маршрутизатор.

Вернемся к тому, что сейчас в сети Интернет более 800к маршрутов. Такое количество придет намаршрутизатор от одного соседа. А если таких соседей 2, 3, 4 и т.д. От каждого соседа будет приходить
800к маршрутов и всю эту информацию маршрутизатор должен обработать и записать в таблицу RIB.

Подключение
~~~~~~~~~~~

Такой вариант подключения называется Full view – список всех анонсируемых в сети интернет префиксов и их атрибутов

Использовать его можно когда вам удобно, но имеет смысл только при выполнении условий:

  * 2+ провайдера
  * Маршрутизатор рассчитан на FIB от 2 млн записей
  * Если ANS транзитная
  * Если вы точно знаете, что full view вам нужен

Второй способ подключения к провайдру - используя только маршрут по умолчанию.

Используется:
  * 1+ провайдера
  * Подойдет любой маршрутизатор
  * Если ANS не транзитная

Примеры настроек
~~~~~~~~~~~~~~~~

Задать соседа BGP и анонсировать ему сеть 100.0.0.1/32:

::

  router bgp 400
    network 100.0.0.1 mask 255.255.255.255
    neighbor 20.0.0.1 remote-as 200

Так же можно задать нескольких соседей. Однако, если у нас есть несколько сосдей с полностью идентичными настройками то желательно использовать такой механизм как peer-group:

::

  router bgp 200
    neighbor 100 peer-group
    neighbor 1.0.0.2 peer-group 100
    neighbor 2.0.0.3 peer-group 100
    neighbor 100 remote-as 100

Сначала необходимо задать саму peer-group. Дальше команды neighbor задают соседей по IP и указывают что они относятся к peer-group 100. Остальные настройки применяются уже к самой peer-group -
задание номера автономной системы соседей. Дальше можно задать какие-либо фильтры.

Смысл такой группы:

  1. Меньше настроек. Нет необходимости для каждого соседа делать одинаковый конфиг.
  2. Для каждого соседа в группе сообщения UPDATE обрабатывается только один раз и применяется обновление сразу ко всем. То есть приходят 10 UPDATE от соседей в группе - обработано будет только одно. Что ускоряет и оптимизует работу маршрутизатора.


Настройка BGP для IPv6 выполняется через address-family:

::

  router bgp 200
    neighbor 2::5 remote-as 65546
    neighbor 20.0.0.10 remote-as 300

    address-family ipv4
      no neighbor 2::5 activate
      neighbor 1.0.0.2 activate
      neighbor 2.0.0.3 activate
      neighbor 20.0.0.10 activate

    address-family ipv6
      network 1::1/128
      neighbor 2::5 activate
    exit-address-family




