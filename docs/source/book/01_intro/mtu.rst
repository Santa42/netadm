MTU
###

Как мы ранее видели, на каждом уровне к данным прибавляются дополнительные заголовки для раздичных видов адресации. То есть изначальные данные увеливаются при прохождении по сети.

В сети интернет заведено что максимальный размер данных передаваемых по сети со всеми заголовками должен равняться 1500 Байт. Это значение назывется MTU

MTU выбает нескольких видов:

.. image:: ../img/01/mtu2.png
       :width: 100 %
       :align: center

Выше обозначены 3 вида MTU

  1. TCP MSS - максимально возможный размер данных передаваемый с уровней приложения на транспортный уровень. То есть количество чистых данных, без каких либо заголовков
  2. IP MTU - максимальный размер IP пакета. В это MTU включается размер полезных данных и заголовки L4. 1500 байт имееются ввиду как раз этот вид MTU
  #. HW MTU - максимальный размер кадра. Сюда включается все заголовки с уровней выше и сами полезные данные.

Однако есть сложность с HW MTU. Разные операционные системы по разному понимают HW MTU.
Например Cisco iOS и iOS XE верна будет ситуции с этой схемы:

.. image:: ../img/01/mtu.png
       :width: 100 %
       :align: center

То есть L2 заголовок не включается в размер HW MTU. Это может привезти к некоторым проблемам в работе протокола маршрутизации OSPF и некоторых других технологий.


Настройка MTU
~~~~~~~~~~~~~

Чтобы настроить значение IP MTU на маршрутизаторе необходимо выполнить следующие действия:

.. code::

    R01(config)#interface gigabitEthernet 5/1
    R01(config-if)#mtu 1532
    R01(config-if)#exit

Проверить настройки MTU на маршрутизаторе:

.. code::

    R01#show interfaces gigabitEthernet 5/1
    GigabitEthernet5/1 is up, line protocol is up (connected)
      Hardware is C6k 1000Mb 802.3, address is 0008.e3ff.fde0 (bia 0008.e3ff.fde0)
      Description: -- --
      MTU 1532 bytes, BW 1000000 Kbit, DLY 10 usec,
        reliability 255/255, txload 82/255, rxload 20/255
    Encapsulation ARPA, loopback not set
    Keepalive set (10 sec)
    Full-duplex, 1000Mb/s, media type is LH

Чтобы настроить значение MSS на интерфейсе маршрутизатора необходимо выполнить следующие действия. Для транзитного трафика:

.. code::

    R01(config)#interface gigabitEthernet 5/1
    R01(config-if)#ip tcp adjust-mss?
    <500-1460>  Maximum segment size in bytes

Либо глобальная настройка маршртизатора. Действует только для сессий установленых не посредственно с маршрутизатором:

.. code::

    R01(config)#ip tcp mss?
    <0-10000>  MSS

На коммутаторах значение MTU обычно настраивается для всей системы полностью, а не по интерфейсам, так же потребуется перезагрузка. Данная настройка применима для FastEthernet:

.. code::

    SW1(config)#system mtu 1600
    SW1(config)#exit
    SW1#reload

Для работы на интерфейсах GigabitEthernet и Ten GigabitEthernet:

.. code::

    SW1(config)#system mtu jumbo 1600
    SW1(config)#exit
    SW1#reload

Так же у коммутатора могут быть маршрутизурующие порты:

.. code::

    SW1(config)#system mtu routing 1600
    SW1(config)#exit
    SW1#reload

Просмотреть значение MTU на коммутаторе:

.. code::
    SW01#show system mtu

    System MTU size is 1600 bytes
    System Jumbo MTU size is 1600 bytes
    Routing MTU size is 1600 bytes

PMTUD
~~~~~

Path MTU Discovery (PMTUD) необходима для поиска корректного значения MTU между двумя узлами.

Суть ее заключается в том, что начинает происходить обмен данными между двумя точками, первое сообщение посылвается с установленным DF(don't fragmentation),
который говорит все системам между двумя нашими узлами о том, что фрагментировать пакет нельзя. Если в какой-то момент пакет не проходит по размеру - отсылается ICMP сообщение(type 3 code 4),
которое говорит источнику, что необходима фрагментация. После получения такого сообщения источник уменьшает размер пакета - фрагментирует, снова устанавливает df-бит и пробует снова. Так происходит
до тех пор пока не будет найдено нужное значение MTU.

Возможные проблемы в таком способе поиска MTU: закрыты ICMP сообщения. То есть нам не будет приходить ICMP type 3 code 4 - не узнаем, что надо фрагментировать. Скорей всего сессия будет виснут
и отваливаться по timeuot